---
title: "Analyses Online Experiments"
author: "Elena Benini"
date: "08 giugno 2020"
output: html_document
---

```{r setup, include=FALSE}

# try if this works for your, otherwise load each package with the line below
if(!require(pacman)) install.packages("pacman")
pacman::p_load("haven", "dplyr", "lme4", "reshape2", "ggplot2", "wesanderson", "afex")

select <- dplyr::select
filter <- dplyr::filter

# write the path to your project folder
setwd('C://Users//Elena//Documents//AA_PhD//Projects//BRAC01_BRAC02//BRAC01-FirstOnline')

# define paths to further subfolders in the project folders (create them first)
dataDir = "data//"
figDir = "figures//"
tabDir = "tables//"

# a .R file with custom functions - define the path to it if different from the working directory
source("C://Users//Elena//Documents//AA_PhD//Projects//expra2020_faces//modelsFun.R")
```

```{r load data}
d <- read.csv(paste0(dataDir, "B1_Pro1", ".csv"), sep = ";", dec = ",")
d1 <- read.csv(paste0(dataDir, "B1_RWTH_horiAA", ".csv"), sep = ";", dec = ",")

d <- rbind(d, d1)
```


```{r count sw rep in each pp}
# numbers of sw and rep
repSw <- as.data.frame(unique(d$pp))
names(repSw) <- "pp"


for (var in c("task_R", "ANSWER_R", "cuecolor_R")){  
  name_rep <- paste(var, "rep", sep = "")
  name_sw <- paste(var, "sw", sep = "")
  repSw[[name_rep]] <- 0
  repSw[[name_sw]] <- 0
  for (j in unique(d$pp)){
    repSw[repSw$pp == j, name_rep] <- sum(d$pp == j & d[, var] == 0)
    repSw[repSw$pp == j, name_sw] <- sum(d$pp == j & d[, var] == 1)
  }
}

#plot
repSw_long <- melt(repSw, id.vars = "pp", measure.vars = c(2:7))
repSw_long$pp <- as.factor(repSw_long$pp)

ggplot(repSw_long, aes(x= pp, y = value, fill = variable)) +
  geom_col(width = 0.9, color = "black", position = position_dodge(0.9)) +
  theme_bw() +
  coord_cartesian(ylim=c(150,225)) +
  theme(axis.title = element_text(face = "bold"))

```

```{r RT vizs}

d$task_R <- as.factor(d$task_R)
d$ANSWER_R <- as.factor(d$ANSWER_R)
d$cuecolor_R <- as.factor(d$cuecolor_R)
d$Attempt <- as.factor(d$Attempt)

drt <- d[(d$task_R != 99 & d$rt > 200 & !is.na(d$Attempt == 1)),]
drt <- drt[!(drt$error == 1 | drt$error_R == 1),]

# average RTs per condition - relevant variables 
glblRel <- group_my(drt, rt, pp, task_R, ANSWER_R, cuecolor_R)
condtnsRel <- group_my(glblRel, meanrt, cuecolor_R, ANSWER_R, task_R)
write.csv2(condtnsRel, paste(tabDir, "rtFigValues.csv", sep = ""))

# barplot
pd = position_dodge(.7)
png("figures//RT.png", width = 800, height = 1000, res = 200)
ggplot(condtnsRel, aes(x= task_R, y = meanmeanrt, fill = ANSWER_R)) +
  geom_col(width = 0.7, color = "black", position = pd) +
  geom_errorbar(aes(ymin  = meanmeanrt - se, ymax  = meanmeanrt + se), width = 0.3, size  = 0.7, position = pd,color = "black") +
  theme_bw() +
  theme(axis.title = element_text(face = "bold")) +
  ylab("Mean RTs") +
  xlab("Task sequence") +
  facet_wrap(~cuecolor_R)
dev.off()

```

```{r error vizs}

de <- d[d$task_R != 99 & d$rt > 200,]

# average RTs per condition - relevant variables 
glblRel <- group_my(de, error, pp, task_R, ANSWER_R, cuecolor_R)
condtnsRel <- group_my(glblRel, meanerror, cuecolor_R, ANSWER_R, task_R)
#write.csv2(condtnsRel, paste(tabDir, "errorFigValues.csv", sep = ""))

# barplot
pd = position_dodge(.7)
#png("figures//RT.png", width = 800, height = 1000, res = 200)
ggplot(condtnsRel, aes(x= task_R, y = meanmeanerror, fill = ANSWER_R)) +
  geom_col(width = 0.7, color = "black", position = pd) +
  geom_errorbar(aes(ymin  = meanmeanerror - se, ymax  = meanmeanerror + se),
                width = 0.3, size  = 0.7, position = pd,color = "black") +
  theme_bw() +
  theme(axis.title = element_text(face = "bold")) +
  ylab("Mean errors") +
  xlab("Task sequence") +
  facet_wrap(~cuecolor_R)
dev.off()

```

```{r RTs dstribution}

hist(drt$rt, freq= F, col=45, main = "", xlab= "RTs values")
# abline(v= mean(drt$rt) + sd(drt$rt), col= "darkblue", lwd= 2)
# abline(v= mean(drt$rt) - sd(drt$rt), col= "darkblue", lwd= 2)
# abline(v= mean(drt$rt) + 2*sd(drt$rt), col= "darkblue", lwd= 1)
# abline(v= mean(drt$rt) - 2*sd(drt$rt), col= "darkblue", lwd= 1)
curve(dnorm(x, mean(drt$rt), sd(drt$rt)), add= T, col= 2, lwd= 2)

drt$logRT <- log(drt$rt)

# much better
hist(drt$logRT, freq= F, col=45, main = "", xlab= "log RTs values")
curve(dnorm(x, mean(drt$logRT), sd(drt$logRT)), add= T, col= 2, lwd= 2)

```

```{r hierarchical structure of the data}

modEmpty <- lmer(logRT ~ 1 + (1|pp), data= drt, REML=F)
summary(modEmpty)

modEmpty1 <- lmer(logRT ~ 1 + (1|pp) + (1|stimulus), data= drt, REML=F)
summary(modEmpty1)

# the pp only is better
anova(modEmpty, modEmpty1)

```


```{r}
mod1 <- lmer(logRT ~ task_R*ANSWER_R*cuecolor_R*cocoa + (1|pp), data= drt, REML=F)
summ <- summary(mod1)
write.csv2(write_pvalues(mod1, "exp"), file= paste0(tabDir, "mod1", ".csv"))
```

